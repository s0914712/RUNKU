<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RUNKU - Vocabulary Practice</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #3B82F6;
      --primary-dark: #2563EB;
      --green: #10B981;
      --green-dark: #059669;
      --orange: #F59E0B;
      --red: #EF4444;
      --purple: #8B5CF6;
      --bg: #F3F4F6;
      --card: #FFFFFF;
      --text: #1F2937;
      --text-light: #6B7280;
      --shadow: 0 4px 24px rgba(0,0,0,0.08);
      --radius: 16px;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans TC', 'Noto Sans JP', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ===== NAV ===== */
    nav {
      background: var(--card);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      position: sticky; top: 0; z-index: 100;
    }
    .nav-inner {
      max-width: 960px; margin: 0 auto;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px; height: 60px;
    }
    .logo { font-size: 22px; font-weight: 800; color: var(--primary); text-decoration: none; cursor: pointer; }
    .nav-links { display: flex; gap: 6px; }
    .nav-btn {
      background: none; border: none; cursor: pointer;
      padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600;
      color: var(--text-light); transition: all .2s;
    }
    .nav-btn:hover { background: #F3F4F6; color: var(--text); }
    .nav-btn.active { background: var(--primary); color: #fff; }

    /* ===== MAIN ===== */
    .container { max-width: 960px; margin: 0 auto; padding: 24px 20px 60px; }

    /* ===== LOADING ===== */
    .loading { text-align: center; padding: 80px 20px; }
    .spinner { width: 48px; height: 48px; border: 4px solid #E5E7EB; border-top-color: var(--primary); border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ===== HOME PAGE ===== */
    .hero { text-align: center; padding: 48px 0 32px; }
    .hero h1 { font-size: 42px; font-weight: 800; margin-bottom: 8px; }
    .hero h1 span { color: var(--primary); }
    .hero p { font-size: 18px; color: var(--text-light); margin-bottom: 32px; }
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; max-width: 600px; margin: 0 auto 32px; }
    .stat-card { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: var(--shadow); }
    .stat-card .num { font-size: 28px; font-weight: 800; color: var(--primary); }
    .stat-card .label { font-size: 13px; color: var(--text-light); margin-top: 4px; }
    .start-btn {
      display: inline-block; padding: 16px 40px; background: var(--primary); color: #fff;
      border: none; border-radius: 12px; font-size: 18px; font-weight: 700; cursor: pointer;
      transition: background .2s, transform .1s; box-shadow: 0 4px 16px rgba(59,130,246,0.3);
    }
    .start-btn:hover { background: var(--primary-dark); transform: translateY(-1px); }

    .features { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 40px; }
    .feature-card {
      border-radius: var(--radius); padding: 32px; color: #fff; cursor: pointer;
      transition: transform .2s, box-shadow .2s;
    }
    .feature-card:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.15); }
    .feature-card .icon { font-size: 48px; margin-bottom: 12px; }
    .feature-card h3 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .feature-card p { font-size: 14px; opacity: 0.9; }
    .bg-blue { background: linear-gradient(135deg, #60A5FA, #3B82F6); }
    .bg-green { background: linear-gradient(135deg, #34D399, #10B981); }
    .bg-purple { background: linear-gradient(135deg, #A78BFA, #8B5CF6); }
    .bg-orange { background: linear-gradient(135deg, #FBBF24, #F59E0B); }

    /* ===== WORD LIST PAGE ===== */
    .page-title { font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 8px; }
    .page-sub { text-align: center; color: var(--text-light); margin-bottom: 24px; font-size: 15px; }
    .cat-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .cat-tab {
      padding: 8px 20px; border-radius: 20px; border: 2px solid #E5E7EB;
      background: var(--card); cursor: pointer; font-size: 14px; font-weight: 600;
      transition: all .2s; color: var(--text);
    }
    .cat-tab:hover { border-color: var(--primary); color: var(--primary); }
    .cat-tab.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .word-table { width: 100%; background: var(--card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    .word-table th, .word-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #F3F4F6; }
    .word-table th { background: #F9FAFB; font-size: 13px; color: var(--text-light); font-weight: 600; }
    .word-table td { font-size: 15px; }
    .word-table tr:last-child td { border-bottom: none; }
    .word-table tr:hover td { background: #F9FAFB; }
    .jp-word { font-size: 18px; font-weight: 700; color: var(--text); }
    .romaji { font-size: 13px; color: var(--primary); margin-top: 2px; }
    .speak-btn-sm {
      background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px;
      border-radius: 50%; transition: background .2s; vertical-align: middle;
    }
    .speak-btn-sm:hover { background: #EFF6FF; }
    .example-text { font-size: 13px; color: var(--text-light); margin-top: 4px; line-height: 1.5; }
    .type-badge {
      display: inline-block; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 700;
      margin-left: 6px; vertical-align: middle;
    }
    .type-badge.jp { background: #DBEAFE; color: #1D4ED8; }
    .type-badge.en { background: #D1FAE5; color: #065F46; }

    /* ===== FLASHCARD PAGE ===== */
    .fc-progress { text-align: center; color: var(--text-light); margin-bottom: 8px; font-size: 14px; }
    .progress-bar { width: 100%; max-width: 600px; margin: 0 auto 32px; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width .3s; }

    .flashcard-wrap { perspective: 1000px; max-width: 600px; margin: 0 auto; }
    .flashcard {
      position: relative; width: 100%; min-height: 360px;
      cursor: pointer; transform-style: preserve-3d; transition: transform .5s;
      border-radius: var(--radius);
    }
    .flashcard.flipped { transform: rotateY(180deg); }
    .fc-face {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      backface-visibility: hidden; border-radius: var(--radius); box-shadow: var(--shadow);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 32px; background: var(--card);
    }
    .fc-back { transform: rotateY(180deg); justify-content: flex-start; align-items: stretch; }
    .fc-front .jp { font-size: 56px; font-weight: 800; margin-bottom: 12px; }
    .fc-front .hint { font-size: 14px; color: var(--text-light); }
    .fc-front .fc-type-label { font-size: 12px; color: var(--text-light); margin-bottom: 12px; }
    .fc-back .answer-word { font-size: 36px; font-weight: 800; color: var(--primary); margin-bottom: 4px; }
    .fc-back .answer-romaji { font-size: 16px; color: var(--text-light); margin-bottom: 4px; }
    .fc-back .answer-meaning { font-size: 20px; font-weight: 600; margin-bottom: 16px; }
    .fc-back .answer-example { background: #EFF6FF; padding: 16px; border-radius: 12px; font-size: 15px; line-height: 1.6; margin-bottom: 8px; width: 100%; }
    .fc-back .answer-example .ex-jp { font-weight: 600; margin-bottom: 4px; }
    .fc-back .answer-example .ex-zh { color: var(--text-light); font-size: 13px; }
    .speak-btn {
      background: var(--primary); color: #fff; border: none; border-radius: 50%;
      width: 44px; height: 44px; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background .2s; margin-left: 12px; flex-shrink: 0;
    }
    .speak-btn:hover { background: var(--primary-dark); }

    .rate-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 24px; max-width: 600px; margin-left: auto; margin-right: auto; }
    .rate-btn {
      padding: 14px 8px; border: none; border-radius: 12px; cursor: pointer;
      font-size: 14px; font-weight: 600; transition: all .2s;
    }
    .rate-btn:hover { transform: translateY(-2px); }
    .rate-0 { background: #FEE2E2; color: #DC2626; }
    .rate-0:hover { background: #FECACA; }
    .rate-1 { background: #FFEDD5; color: #EA580C; }
    .rate-1:hover { background: #FED7AA; }
    .rate-2 { background: #FEF9C3; color: #CA8A04; }
    .rate-2:hover { background: #FEF08A; }
    .rate-3 { background: #DCFCE7; color: #16A34A; }
    .rate-3:hover { background: #BBF7D0; }
    .fc-hint-bottom { text-align: center; color: var(--text-light); font-size: 13px; margin-top: 16px; }

    /* ===== QUIZ PAGE ===== */
    .quiz-card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 40px; max-width: 600px; margin: 0 auto; text-align: center; }
    .quiz-question { font-size: 48px; font-weight: 800; margin-bottom: 8px; }
    .quiz-sub { font-size: 14px; color: var(--text-light); margin-bottom: 28px; }
    .quiz-options { display: grid; gap: 12px; }
    .quiz-opt {
      padding: 16px; border: 2px solid #E5E7EB; border-radius: 12px; background: var(--card);
      cursor: pointer; font-size: 16px; font-weight: 600; transition: all .2s; text-align: left;
    }
    .quiz-opt:hover { border-color: var(--primary); background: #EFF6FF; }
    .quiz-opt.correct { border-color: var(--green); background: #DCFCE7; }
    .quiz-opt.wrong { border-color: var(--red); background: #FEE2E2; }
    .quiz-opt.reveal { border-color: var(--green); background: #DCFCE7; }
    .quiz-score { margin-top: 32px; }
    .quiz-score .big { font-size: 64px; font-weight: 800; color: var(--primary); }
    .quiz-score p { font-size: 16px; color: var(--text-light); margin-top: 8px; }

    /* ===== RESULT / COMPLETE ===== */
    .complete-card { text-align: center; padding: 48px; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); max-width: 500px; margin: 40px auto; }
    .complete-card .big-icon { font-size: 72px; margin-bottom: 16px; }
    .complete-card h2 { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
    .complete-card p { color: var(--text-light); margin-bottom: 24px; }

    /* ===== UTILITIES ===== */
    .hidden { display: none !important; }
    .mt-16 { margin-top: 16px; }
    .mt-24 { margin-top: 24px; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 640px) {
      .hero h1 { font-size: 28px; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .features { grid-template-columns: 1fr; }
      .nav-links { gap: 2px; }
      .nav-btn { padding: 6px 10px; font-size: 13px; }
      .fc-front .jp { font-size: 40px; }
      .rate-buttons { grid-template-columns: repeat(2, 1fr); }
      .word-table th:nth-child(4), .word-table td:nth-child(4) { display: none; }
      .quiz-question { font-size: 36px; }
    }
  </style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-inner">
    <span class="logo" onclick="showPage('home')">RUNKU</span>
    <div class="nav-links">
      <button class="nav-btn active" data-page="home" onclick="showPage('home')">Home</button>
      <button class="nav-btn" data-page="list" onclick="showPage('list')">Word List</button>
      <button class="nav-btn" data-page="flashcard" onclick="showPage('flashcard')">Flashcard</button>
      <button class="nav-btn" data-page="quiz" onclick="showPage('quiz')">Quiz</button>
    </div>
  </div>
</nav>

<!-- PAGES -->
<div class="container">

  <!-- ========== HOME ========== -->
  <div id="page-home">
    <div class="hero">
      <h1>Welcome to <span>RUNKU</span></h1>
      <p id="home-subtitle">Vocabulary Practice</p>
      <div class="stats-row">
        <div class="stat-card"><div class="num" id="s-total">0</div><div class="label">Total Words</div></div>
        <div class="stat-card"><div class="num" id="s-learning">0</div><div class="label">Learning</div></div>
        <div class="stat-card"><div class="num" id="s-review">0</div><div class="label">Reviewing</div></div>
        <div class="stat-card"><div class="num" id="s-mastered">0</div><div class="label">Mastered</div></div>
      </div>
      <button class="start-btn" onclick="showPage('flashcard')">Start Learning &rarr;</button>
    </div>
    <div class="features">
      <div class="feature-card bg-blue" onclick="showPage('list')">
        <div class="icon">üìñ</div><h3>Word List</h3><p>Browse all vocabulary with examples</p>
      </div>
      <div class="feature-card bg-green" onclick="showPage('flashcard')">
        <div class="icon">üìù</div><h3>Flashcards</h3><p>Spaced repetition study</p>
      </div>
      <div class="feature-card bg-purple" onclick="showPage('quiz')">
        <div class="icon">üéØ</div><h3>Quiz</h3><p>Test your knowledge</p>
      </div>
      <div class="feature-card bg-orange" onclick="resetProgress()">
        <div class="icon">üîÑ</div><h3>Reset</h3><p>Clear progress & start fresh</p>
      </div>
    </div>
  </div>

  <!-- ========== WORD LIST ========== -->
  <div id="page-list" class="hidden">
    <h1 class="page-title">Word List</h1>
    <p class="page-sub" id="list-sub">Browse all vocabulary words</p>
    <div class="cat-tabs" id="list-tabs"></div>
    <table class="word-table">
      <thead>
        <tr><th>#</th><th>Word</th><th>Meaning</th><th>Example</th><th></th></tr>
      </thead>
      <tbody id="word-tbody"></tbody>
    </table>
  </div>

  <!-- ========== FLASHCARD ========== -->
  <div id="page-flashcard" class="hidden">
    <h1 class="page-title">Flashcard Practice</h1>
    <div class="cat-tabs mt-16" id="fc-tabs"></div>
    <div class="fc-progress mt-16" id="fc-progress">1 / 20</div>
    <div class="progress-bar"><div class="progress-fill" id="fc-bar" style="width:5%"></div></div>

    <div id="fc-card-area">
      <div class="flashcard-wrap">
        <div class="flashcard" id="flashcard" onclick="flipCard()">
          <div class="fc-face fc-front">
            <div class="fc-type-label" id="fc-type-label"></div>
            <div class="jp" id="fc-jp"></div>
            <div class="hint">Click to reveal answer</div>
          </div>
          <div class="fc-face fc-back">
            <div style="display:flex;align-items:center;margin-bottom:4px;">
              <span class="answer-word" id="fc-answer-word"></span>
              <button class="speak-btn" id="fc-speak-btn" onclick="event.stopPropagation();">üîä</button>
            </div>
            <div class="answer-romaji" id="fc-romaji"></div>
            <div class="answer-meaning" id="fc-meaning"></div>
            <div class="answer-example" id="fc-example-area">
              <div class="ex-jp" id="fc-ex-jp"></div>
              <div class="ex-zh" id="fc-ex-zh"></div>
              <button class="speak-btn-sm" id="fc-speak-example" onclick="event.stopPropagation();" style="margin-top:6px;">üîä Listen</button>
            </div>
          </div>
        </div>
      </div>
      <div class="rate-buttons" id="fc-rate" style="visibility:hidden;">
        <button class="rate-btn rate-0" onclick="rateCard(0)">üò∞ Unknown</button>
        <button class="rate-btn rate-1" onclick="rateCard(1)">üòï Hard</button>
        <button class="rate-btn rate-2" onclick="rateCard(2)">üôÇ Okay</button>
        <button class="rate-btn rate-3" onclick="rateCard(3)">üòä Easy</button>
      </div>
      <div class="fc-hint-bottom">Press Space to flip &middot; Keys 1-4 to rate</div>
    </div>

    <div id="fc-complete" class="hidden">
      <div class="complete-card">
        <div class="big-icon">üéâ</div>
        <h2>Session Complete!</h2>
        <p id="fc-complete-msg">You reviewed all words.</p>
        <button class="start-btn" onclick="startFlashcards(fcCategory)">Practice Again</button>
      </div>
    </div>
  </div>

  <!-- ========== QUIZ ========== -->
  <div id="page-quiz" class="hidden">
    <h1 class="page-title">Quiz Mode</h1>
    <p class="page-sub">Choose the correct meaning</p>
    <div class="cat-tabs mt-16" id="qz-tabs"></div>

    <div id="quiz-area" class="mt-24">
      <div class="fc-progress" id="qz-progress">1 / 10</div>
      <div class="progress-bar"><div class="progress-fill" id="qz-bar" style="width:10%"></div></div>
      <div class="quiz-card mt-24">
        <div class="quiz-question" id="qz-question"></div>
        <div class="quiz-sub" id="qz-romaji"></div>
        <button class="speak-btn-sm" id="qz-speak" style="margin-bottom:20px;font-size:24px;">üîä</button>
        <div class="quiz-options" id="qz-options"></div>
      </div>
    </div>

    <div id="quiz-result" class="hidden">
      <div class="complete-card">
        <div class="big-icon">üèÜ</div>
        <h2>Quiz Complete!</h2>
        <div class="quiz-score">
          <div class="big" id="qz-score"></div>
          <p id="qz-result-msg"></p>
        </div>
        <button class="start-btn mt-24" onclick="startQuiz(qzCategory)">Try Again</button>
      </div>
    </div>
  </div>

  <!-- ========== LOADING ========== -->
  <div id="page-loading" class="hidden">
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading vocabulary...</p>
    </div>
  </div>

</div>

<script>
// ===== GLOBALS =====
let WORDS = [];
let CATEGORIES = []; // [{ key, name, type, count }]

// ===== PARSE words FILE =====
function parseWordsFile(text) {
  const words = [];
  const categories = [];
  let currentCat = null;
  let currentType = 'japanese';
  let id = 0;

  for (const raw of text.split('\n')) {
    const line = raw.trim();
    if (!line || line.startsWith('#')) continue;

    // Category header: [Name]
    const catMatch = line.match(/^\[(.+)\]$/);
    if (catMatch) {
      currentCat = catMatch[1].trim();
      const key = currentCat.toLowerCase().replace(/[^a-z0-9\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]+/g, '_');
      categories.push({ key, name: currentCat, type: 'japanese', count: 0 });
      continue;
    }

    // Type declaration
    if (line.toLowerCase().startsWith('type:')) {
      const t = line.split(':')[1].trim().toLowerCase();
      if (categories.length > 0) categories[categories.length - 1].type = t;
      currentType = t;
      continue;
    }

    // Word line
    if (!currentCat) continue;
    const parts = line.split('|').map(s => s.trim());
    const catInfo = categories[categories.length - 1];
    id++;

    if (currentType === 'japanese' && parts.length >= 3) {
      words.push({
        id,
        word: parts[0],
        romaji: parts[1] || '',
        meaning: parts[2] || '',
        category: catInfo.key,
        categoryName: catInfo.name,
        type: 'japanese',
        example_jp: parts[3] || '',
        example_zh: parts[4] || '',
      });
      catInfo.count++;
    } else if (currentType === 'english' && parts.length >= 2) {
      words.push({
        id,
        word: parts[0],
        romaji: '',
        meaning: parts[1],
        category: catInfo.key,
        categoryName: catInfo.name,
        type: 'english',
        example_jp: '',
        example_zh: '',
      });
      catInfo.count++;
    }
  }

  return { words, categories };
}

// ===== LOAD WORDS =====
async function loadWords() {
  try {
    const res = await fetch('words');
    if (!res.ok) throw new Error('fetch failed');
    const text = await res.text();
    const parsed = parseWordsFile(text);
    if (parsed.words.length > 0) {
      WORDS = parsed.words;
      CATEGORIES = parsed.categories;
    }
  } catch (e) {
    console.warn('Could not fetch words file, using fallback data.', e);
    useFallback();
  }
  initApp();
}

function useFallback() {
  WORDS = [
    { id:1,  word:"„ÅÑ„Åè„Çâ",     romaji:"Ikura",       meaning:"Â§öÂ∞ëÈå¢",       category:"shopping", categoryName:"Shopping", type:"japanese", example_jp:"„Åì„Çå„ÅØ„ÅÑ„Åè„Çâ„Åß„Åô„ÅãÔºü", example_zh:"ÈÄôÂ§öÂ∞ëÈå¢Ôºü" },
    { id:2,  word:"ÂÖçÁ®é",       romaji:"Menzei",      meaning:"ÂÖçÁ®Ö",         category:"shopping", categoryName:"Shopping", type:"japanese", example_jp:"ÂÖçÁ®é„ÅØ„Åß„Åç„Åæ„Åô„ÅãÔºü", example_zh:"ÂèØ‰ª•ÂÖçÁ®ÖÂóéÔºü" },
    { id:3,  word:"„Åä„ÅØ„Çà„ÅÜ",   romaji:"Ohay≈ç",       meaning:"Êó©ÂÆâ",         category:"greetings", categoryName:"Greetings", type:"japanese", example_jp:"„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ", example_zh:"Êó©ÂÆâ„ÄÇÔºàÊ≠£ÂºèË™™Ê≥ïÔºâ" },
    { id:4,  word:"„ÅÇ„Çä„Åå„Å®„ÅÜ", romaji:"Arigat≈ç",     meaning:"Ë¨ùË¨ù",         category:"greetings", categoryName:"Greetings", type:"japanese", example_jp:"„ÅÑ„Å§„ÇÇ„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ", example_zh:"‰∏ÄÁõ¥‰ª•‰æÜÈÉΩÈùûÂ∏∏ÊÑüË¨ù„ÄÇ" },
    { id:5,  word:"open",       romaji:"",            meaning:"ÈñãÊîæ",         category:"english", categoryName:"English", type:"english", example_jp:"", example_zh:"" },
    { id:6,  word:"learn",      romaji:"",            meaning:"Â≠∏Áøí",         category:"english", categoryName:"English", type:"english", example_jp:"", example_zh:"" },
  ];
  CATEGORIES = [
    { key:"shopping", name:"Shopping", type:"japanese", count:2 },
    { key:"greetings", name:"Greetings", type:"japanese", count:2 },
    { key:"english", name:"English", type:"english", count:2 },
  ];
}

// ===== INIT =====
function initApp() {
  buildCategoryTabs();
  updateHomeStats();
  const catNames = CATEGORIES.map(c => c.name.split('/')[0].trim());
  document.getElementById('home-subtitle').textContent = catNames.join(' / ') + ' Vocabulary Practice';
}

// ===== BUILD CATEGORY TABS (dynamic) =====
function buildCategoryTabs() {
  const containers = [
    { el: document.getElementById('list-tabs'), prefix: 'list' },
    { el: document.getElementById('fc-tabs'),   prefix: 'fc' },
    { el: document.getElementById('qz-tabs'),   prefix: 'qz' },
  ];

  for (const { el, prefix } of containers) {
    el.innerHTML = '';
    // "All" tab
    const allBtn = document.createElement('button');
    allBtn.className = 'cat-tab active';
    allBtn.dataset.cat = 'all';
    allBtn.textContent = `All (${WORDS.length})`;
    if (prefix === 'list') allBtn.onclick = () => filterCategory('all', allBtn);
    else if (prefix === 'fc') allBtn.onclick = () => startFlashcards('all');
    else allBtn.onclick = () => startQuiz('all');
    el.appendChild(allBtn);

    // Per-category tabs
    for (const cat of CATEGORIES) {
      const btn = document.createElement('button');
      btn.className = 'cat-tab';
      btn.dataset.cat = cat.key;
      btn.textContent = `${cat.name} (${cat.count})`;
      if (prefix === 'list') btn.onclick = () => filterCategory(cat.key, btn);
      else if (prefix === 'fc') btn.onclick = () => startFlashcards(cat.key);
      else btn.onclick = () => startQuiz(cat.key);
      el.appendChild(btn);
    }
  }
}

function setActiveTab(containerId, catKey) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.querySelectorAll('.cat-tab').forEach(b => b.classList.toggle('active', b.dataset.cat === catKey));
}

// ===== LOCAL STORAGE =====
function loadRecords() {
  try { return JSON.parse(localStorage.getItem('runku_records') || '{}'); } catch { return {}; }
}
function saveRecords(r) { localStorage.setItem('runku_records', JSON.stringify(r)); }

function updateHomeStats() {
  const r = loadRecords();
  const vals = Object.values(r);
  document.getElementById('s-total').textContent = WORDS.length;
  document.getElementById('s-learning').textContent = vals.filter(v => v.familiarity < 2).length;
  document.getElementById('s-review').textContent = vals.filter(v => v.familiarity >= 2 && v.familiarity < 3).length;
  document.getElementById('s-mastered').textContent = vals.filter(v => v.familiarity >= 3).length;
}

function resetProgress() {
  if (confirm('Are you sure you want to reset all learning progress?')) {
    localStorage.removeItem('runku_records');
    updateHomeStats();
    alert('Progress has been reset.');
  }
}

// ===== SPEECH =====
function speakWord(text, type) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = type === 'english' ? 'en-US' : 'ja-JP';
  u.rate = 0.85;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// ===== PAGE NAVIGATION =====
let currentPage = 'home';
function showPage(name) {
  currentPage = name;
  ['home','list','flashcard','quiz','loading'].forEach(p => {
    document.getElementById('page-' + p).classList.toggle('hidden', p !== name);
  });
  document.querySelectorAll('.nav-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.page === name);
  });
  if (name === 'home') updateHomeStats();
  if (name === 'list') { setActiveTab('list-tabs', 'all'); renderWordList('all'); }
  if (name === 'flashcard') startFlashcards('all');
  if (name === 'quiz') startQuiz('all');
  window.scrollTo(0, 0);
}

// ===== WORD LIST =====
function filterCategory(cat, btn) {
  setActiveTab('list-tabs', cat);
  renderWordList(cat);
}

function renderWordList(cat) {
  const filtered = cat === 'all' ? WORDS : WORDS.filter(w => w.category === cat);
  document.getElementById('list-sub').textContent = `Browse all ${filtered.length} vocabulary words`;

  const tbody = document.getElementById('word-tbody');
  tbody.innerHTML = filtered.map((w, i) => {
    const badge = w.type === 'english'
      ? '<span class="type-badge en">EN</span>'
      : '<span class="type-badge jp">JP</span>';
    const romaji = w.romaji ? `<div class="romaji">${esc(w.romaji)}</div>` : '';
    const example = w.example_jp
      ? `<div style="font-size:14px;">${esc(w.example_jp)}</div><div class="example-text">${esc(w.example_zh)}</div>`
      : '<span style="color:#ccc;">-</span>';
    return `<tr>
      <td>${i + 1}</td>
      <td>
        <div class="jp-word">${esc(w.word)} ${badge}</div>
        ${romaji}
      </td>
      <td>${esc(w.meaning)}</td>
      <td>${example}</td>
      <td><button class="speak-btn-sm" onclick="speakWord('${escAttr(w.word)}','${w.type}')">üîä</button></td>
    </tr>`;
  }).join('');
}

// ===== FLASHCARD =====
let fcWords = [], fcIdx = 0, fcFlipped = false, fcCategory = 'all';

function currentFCWord() { return fcWords[fcIdx] || WORDS[0]; }

function startFlashcards(cat) {
  fcCategory = cat;
  setActiveTab('fc-tabs', cat);

  fcWords = shuffle(cat === 'all' ? [...WORDS] : WORDS.filter(w => w.category === cat));
  fcIdx = 0;
  fcFlipped = false;
  document.getElementById('fc-card-area').classList.remove('hidden');
  document.getElementById('fc-complete').classList.add('hidden');
  renderFC();
}

function renderFC() {
  if (fcIdx >= fcWords.length) {
    document.getElementById('fc-card-area').classList.add('hidden');
    document.getElementById('fc-complete').classList.remove('hidden');
    document.getElementById('fc-complete-msg').textContent = `You reviewed ${fcWords.length} words this session.`;
    return;
  }
  const w = fcWords[fcIdx];
  const isJP = w.type === 'japanese';

  document.getElementById('fc-jp').textContent = w.word;
  document.getElementById('fc-type-label').textContent = isJP ? 'üáØüáµ Japanese' : 'üá¨üáß English';
  document.getElementById('fc-answer-word').textContent = w.word;
  document.getElementById('fc-romaji').textContent = w.romaji || '';
  document.getElementById('fc-romaji').style.display = w.romaji ? '' : 'none';
  document.getElementById('fc-meaning').textContent = w.meaning;

  const exArea = document.getElementById('fc-example-area');
  if (w.example_jp) {
    exArea.style.display = '';
    document.getElementById('fc-ex-jp').textContent = w.example_jp;
    document.getElementById('fc-ex-zh').textContent = w.example_zh;
  } else {
    exArea.style.display = 'none';
  }

  // Rebind speak buttons
  document.getElementById('fc-speak-btn').onclick = (e) => { e.stopPropagation(); speakWord(w.word, w.type); };
  document.getElementById('fc-speak-example').onclick = (e) => { e.stopPropagation(); speakWord(w.example_jp, 'japanese'); };

  document.getElementById('fc-progress').textContent = `${fcIdx + 1} / ${fcWords.length}`;
  document.getElementById('fc-bar').style.width = ((fcIdx + 1) / fcWords.length * 100) + '%';
  document.getElementById('flashcard').classList.remove('flipped');
  document.getElementById('fc-rate').style.visibility = 'hidden';
  fcFlipped = false;
}

function flipCard() {
  fcFlipped = !fcFlipped;
  document.getElementById('flashcard').classList.toggle('flipped', fcFlipped);
  document.getElementById('fc-rate').style.visibility = fcFlipped ? 'visible' : 'hidden';
}

function rateCard(familiarity) {
  const w = fcWords[fcIdx];
  const records = loadRecords();
  const key = w.word;
  const prev = records[key] || { familiarity: 0, review_count: 0, last_interval: 1 };
  let interval;
  if (familiarity <= 1) interval = 0.25;
  else if (familiarity === 2) interval = prev.review_count === 0 ? 1 : prev.last_interval * 1.5;
  else interval = prev.review_count === 0 ? 3 : prev.last_interval * 2;

  const next = new Date();
  next.setHours(next.getHours() + interval * 24);
  records[key] = {
    familiarity,
    review_count: prev.review_count + 1,
    last_interval: interval,
    next_review: next.toISOString(),
    last_reviewed: new Date().toISOString(),
  };
  saveRecords(records);
  fcIdx++;
  renderFC();
}

// ===== QUIZ =====
let quizWords = [], qzIdx = 0, qzCorrect = 0, qzAnswered = false, qzCategory = 'all';

function startQuiz(cat) {
  qzCategory = cat;
  setActiveTab('qz-tabs', cat);

  quizWords = shuffle(cat === 'all' ? [...WORDS] : WORDS.filter(w => w.category === cat));
  qzIdx = 0; qzCorrect = 0; qzAnswered = false;
  document.getElementById('quiz-area').classList.remove('hidden');
  document.getElementById('quiz-result').classList.add('hidden');
  renderQuiz();
}

function renderQuiz() {
  if (qzIdx >= quizWords.length) {
    document.getElementById('quiz-area').classList.add('hidden');
    document.getElementById('quiz-result').classList.remove('hidden');
    const pct = Math.round(qzCorrect / quizWords.length * 100);
    document.getElementById('qz-score').textContent = pct + '%';
    document.getElementById('qz-result-msg').textContent = `${qzCorrect} / ${quizWords.length} correct`;
    return;
  }
  qzAnswered = false;
  const w = quizWords[qzIdx];
  document.getElementById('qz-question').textContent = w.word;
  document.getElementById('qz-romaji').textContent = w.romaji || (w.type === 'english' ? 'English' : '');
  document.getElementById('qz-progress').textContent = `${qzIdx + 1} / ${quizWords.length}`;
  document.getElementById('qz-bar').style.width = ((qzIdx + 1) / quizWords.length * 100) + '%';
  document.getElementById('qz-speak').onclick = () => speakWord(w.word, w.type);

  // Build 4 options (1 correct + 3 wrong from same pool)
  const wrongPool = WORDS.filter(x => x.id !== w.id);
  const wrongs = shuffle(wrongPool).slice(0, 3);
  const options = shuffle([w, ...wrongs]);

  const container = document.getElementById('qz-options');
  container.innerHTML = options.map(o =>
    `<button class="quiz-opt" data-correct="${o.id === w.id}" onclick="answerQuiz(this, ${o.id === w.id})">${esc(o.meaning)}</button>`
  ).join('');
}

function answerQuiz(btn, isCorrect) {
  if (qzAnswered) return;
  qzAnswered = true;
  if (isCorrect) {
    btn.classList.add('correct');
    qzCorrect++;
  } else {
    btn.classList.add('wrong');
    document.querySelectorAll('.quiz-opt').forEach(b => {
      if (b.dataset.correct === 'true') b.classList.add('reveal');
    });
  }
  setTimeout(() => { qzIdx++; renderQuiz(); }, 1200);
}

// ===== KEYBOARD =====
document.addEventListener('keydown', e => {
  if (currentPage !== 'flashcard') return;
  if (e.code === 'Space') { e.preventDefault(); flipCard(); }
  if (fcFlipped && e.key >= '1' && e.key <= '4') rateCard(parseInt(e.key) - 1);
});

// ===== UTILS =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function escAttr(s) {
  return s.replace(/'/g, "\\'").replace(/\\/g, '\\\\');
}

// ===== BOOT =====
loadWords();
</script>

</body>
</html>
